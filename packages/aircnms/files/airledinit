#!/bin/sh /etc/rc.common

USE_PROCD=1

START=99
STOP=01

NAME=led_state
SCRIPT=/usr/sbin/led_state.sh

start_service() {
	# --- Hardware check: ensure required LEDs exist ---
	for led in system wlan2g wlan5g; do
		if [ ! -w "/sys/class/leds/$led/brightness" ]; then
			logger -t "$NAME" "LED '/sys/class/leds/$led/brightness' not found or not writable. Skipping start."
			return 1
		fi
	done

	# --- Script check ---
	if [ ! -x "$SCRIPT" ]; then
		logger -t "$NAME" "Script '$SCRIPT' not found or not executable."
		return 1
	fi

	# --- Register with procd ---
	logger -t "$NAME" "Starting supervised LED daemon"

	procd_open_instance
	procd_set_param command "$SCRIPT"
	procd_set_param respawn 3600 5 5   # respawn after crash, max 5 tries
	procd_set_param stdout 1           # suppress logs (set 1 for debug)
	procd_set_param stderr 1
	procd_close_instance
}

stop_service() {
	# Turn off all managed LEDs on stop
	for led in system wlan2g wlan5g; do
		if [ -w "/sys/class/leds/$led/brightness" ]; then
			echo 0 > "/sys/class/leds/$led/brightness"
		fi
	done
}
